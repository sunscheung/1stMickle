<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{
            margin:0;
            padding:0;
            box-sizing:border-box;
        }
        html,body, #app{
            height:100%;
            overflow: hidden;
        }
        .toolbar{
            height:50px;
            width:500px;
            margin:auto;
        }
        .container{
            height:calc(100% - 50px);
            overflow-y:auto;
        }
        .header{
            height:50px;
            background-color: #58a;
        }
        .footer{
            height:50px;
            width:500px;
            background-color: #9c3;
        }
        .content{
            position:relative;
            width:500px;
            margin:auto;
            border: 1px solid #cdcdcd;

            /*transform:scale(1);*/
        }
        .content>.bd{
            border-top:2px solid #999;
            padding-bottom:20px;
        }
        .content>.bd .message,
        .content>.bd .draft{
            font-size:20px;
            line-height:3;
        }
        .bd>.message+.draft{
            border-top:1px solid #f00;
        }
        .message{
            background-color: #999;
        }
        .message-container+.message-container{
            margin-top:50px;
        }
        .draft{
            min-height:400px;
        }
        .sticky-footer{
            position:fixed;
            left:auto;
            bottom:0;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="toolbar">
        toolbar
    </div>
    <div class="container" @scroll="scrollMail">
        <div class="content">
            <div class="header">mail header</div>
            <div class="bd">
                <div class="message-container" v-for="(message,index) in thread.messages">
                    <div class="reply">
                        <div>{{index}}</div>
                        <button @click="reply(index)">回复</button>
                        <button @click="replyAll(index)">全部回复</button>
                        <button @click="forward(index)">转发</button>
                    </div>
                    <div class="message" v-html="message.html"></div>
                    <div class="draft" v-if="message.isOpen">
                        <div class="header">
                            draft header
                        </div>
                        <span v-if="message.draft.type!=='forward'">...</span>
                        <div v-else v-html="message.draft.html"></div>
                        <div class="footer" :class="[{'sticky-footer':isSticky && (message.draft.type==='forward')}]">draft footer</div>
                    </div>
                </div>
            </div>
            <div class="footer">mail footer</div>
        </div>
    </div>
</div>

<script src="./mailData.js"></script>
<script src="../../../../lib/jquery-1.11.3.min.js"></script>
<script src="../../../../lib/vue.js"></script>
<script>
    let scrollInitHeight = 400
    new Vue({
        el:'#app',
        data: {
          thread: thread,
          isSticky: true,
            lastIndex: -1,
          curIndex: -1
        },
        methods: {
            reply (index){
               this.thread.messages[index].isOpen = !this.thread.messages[index].isOpen
               this.thread.messages[index].draft.type = 'reply'
               this.thread.messages[index].draft.html = 'reply <br/>' + this.thread.messages[index].html
           },
            replyAll (index) {
                this.thread.messages[index].isOpen = !this.thread.messages[index].isOpen
                this.thread.messages[index].draft.type = 'replyAll'
                this.thread.messages[index].draft.html = 'reply all <br/>' + this.thread.messages[index].html
            },
            forward (index){
               this.thread.messages[index].isOpen = !this.thread.messages[index].isOpen
               this.thread.messages[index].draft.type = 'forward'
               this.thread.messages[index].draft.html = 'forward <br/>' + this.thread.messages[index].html
               if (this.thread.messages[index].isOpen) {
                   this.curIndex = index
                   this.messageScroll(index)
               }
            },
            messageScroll (index) {
              this.$nextTick(() => {
                let ndMessage = $('.message-container').get(index)
                let top = $(ndMessage).find('.draft').offset().top
//                let heightToolbar = $('.toolbar').outerHeight()
//                console.log($(ndMessage).find('.draft').offset())
                $('.container').scrollTop(top - (window.innerHeight - scrollInitHeight))
              })
            },
            scrollMail () {
                if (this.curIndex < 0) {
                  return
                }
//                console.log('%c-----------------------------------------------------------', 'background-color:#85a;color:#fff;font-size:30px;')
                let ndMessage = $('.message-container').get(this.curIndex)
                console.log('top:', $(ndMessage).find('.draft').offset().top)
                console.log('outerHeight:', $(ndMessage).find('.draft').outerHeight())
                let top = $(ndMessage).find('.draft').offset().top
                let outerHeight = $(ndMessage).find('.draft').outerHeight()
                if (top > scrollInitHeight + 100 || (-top + 50) > outerHeight) {
//                  console.log('cancel sticky')
                  this.isSticky = false
                  this.curIndex = -1
//                  this.lastIndex = -1
                } else {
                  this.isSticky = true
//                  this.curIndex = this.lastIndex
                }
            }
        }
    })
</script>
</body>
</html>