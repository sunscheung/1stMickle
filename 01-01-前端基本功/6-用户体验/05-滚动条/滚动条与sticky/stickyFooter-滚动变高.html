<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>
        sticky header and footer
        随着滚动条的滚动，
        当进入元素的可视区域，容器的scrollTop 元素的top都在变化
        offsetTop:元素上边缘距离容器上边缘的距离，始终不变
        元素高度、窗体高度始终不变

        offset() offsetParent()
    </title>
    <style>
        *{
            margin:0;
            padding:0;
            box-sizing:border-box;
        }
        html,body, #app{
            height:100%;
            overflow: hidden;
        }
        .toolbar{
            height:50px;
            width:500px;
            margin:auto;
        }
        .container{
            height:calc(100% - 50px);
            overflow-y:auto;
        }
        .header{
            height:50px;
            background-color: #58a;
        }
        .footer{
            height:50px;
            width:500px;
            background-color: #9c3;
        }
        .content{
            position:relative;
            width:500px;
            margin:auto;
            border: 1px solid #cdcdcd;

            /*transform:scale(1);*/
        }
        .content>.bd{
            border-top:2px solid #999;
            padding-bottom:20px;
        }
        .content>.bd .message,
        .content>.bd .draft{
            font-size:20px;
            line-height:3;
        }
        .bd>.message+.draft{
            border-top:1px solid #f00;
        }
        .message{
            background-color: #999;
        }
        .message-container+.message-container{
            margin-top:50px;
        }
        .draft{
            min-height:400px;
        }
        .sticky-footer{
            position:fixed;
            left:auto;
            bottom:0;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="toolbar">
        toolbar
    </div>
    <div class="container" @scroll="scrollMail">
        <div class="content">
            <div class="header">mail header</div>
            <div class="bd">
                <div class="message-container" v-for="(message,index) in thread.messages">
                    <div class="reply">
                        <div>{{index}}</div>
                        <button @click="reply(index)">回复</button>
                        <button @click="replyAll(index)">全部回复</button>
                        <button @click="forward(index)">转发</button>
                    </div>
                    <div class="message" v-html="message.html"></div>
                    <div class="draft" v-if="message.isOpen">
                        <div class="header">
                            draft header
                        </div>
                        <span v-if="message.draft.type!=='forward'">...</span>
                        <div v-else v-html="message.draft.html"></div>
                        <div class="footer" :class="[{'sticky-footer':isSticky && (message.draft.type==='forward')}]">draft footer</div>
                    </div>
                </div>
            </div>
            <div class="footer">mail footer</div>
        </div>
    </div>
</div>

<script src="./mailData.js"></script>
<script src="../../../../lib/jquery-1.11.3.min.js"></script>
<script src="../../../../lib/vue.js"></script>
<script>
    let scrollInitHeight = 400 // 草稿高度大于可视区域时，显示的初始高度
    new Vue({
        el:'#app',
        data: {
          thread: thread,
          isSticky: true,
          curIndex: -1
        },
        methods: {
            reply (index){
               this.thread.messages[index].isOpen = !this.thread.messages[index].isOpen
               this.thread.messages[index].draft.type = 'reply'
               this.thread.messages[index].draft.html = 'reply <br/>' + this.thread.messages[index].html
               if (this.thread.messages[index].isOpen) {
                  this.messageScroll(index)
               }
           },
            replyAll (index) {
                this.thread.messages[index].isOpen = !this.thread.messages[index].isOpen
                this.thread.messages[index].draft.type = 'replyAll'
                this.thread.messages[index].draft.html = 'reply all <br/>' + this.thread.messages[index].html
                if (this.thread.messages[index].isOpen) {
                   this.messageScroll(index)
                }
            },
            forward (index){
               this.thread.messages[index].isOpen = !this.thread.messages[index].isOpen
               this.thread.messages[index].draft.type = 'forward'
               this.thread.messages[index].draft.html = 'forward <br/>' + this.thread.messages[index].html
               if (this.thread.messages[index].isOpen) {
                   this.curIndex = index
                   this.messageScroll(index)
               }
            },
            messageScroll (index) {
              this.$nextTick(() => {
                let ndMessage = $('.message-container').get(index)
                let parentOffsetTop = $(ndMessage).find('.draft').get(0).offsetTop // 草稿元素距离浏览器顶部的距离
//                let heightToolbar = $('.toolbar').outerHeight()
                $('.container').scrollTop(parentOffsetTop - (window.innerHeight - scrollInitHeight))
              })
            },
            scrollMail () {
                let ndMessage = $('.message-container').get(this.curIndex)
                let ndDraft = $(ndMessage).find('.draft')
                if (!ndDraft.get(0)) {
                  return
                }
                console.log('parentOffsetTop:', $(ndMessage).find('.draft').get(0).offsetTop)
                console.log('outerHeight:', $(ndMessage).find('.draft').outerHeight())
                let parentOffsetTop = $(ndMessage).find('.draft').get(0).offsetTop
                let outerHeight = $(ndMessage).find('.draft').outerHeight()
//                if ((top > (window.innerHeight - 50*2)) || ((-top + window.innerHeight) > outerHeight)) {
//                  this.isSticky = false
//                } else {
//                  this.isSticky = true
//                }
                this.getCurIndex();
            },
            getCurIndex () {
//                console.log('container scrollTop:',document.querySelector('.container').scrollTop)
                let containerScrollTop = document.querySelector('.container').scrollTop
                let size = $('.message-container .draft').size()
                let domArray = $('.message-container .draft').toArray();
                if (size > 0) {
                    console.log(size,domArray)
                    domArray.map((item,index) => {
                        let parentOffsetTop = item.offsetTop
                        let height = $(item).outerHeight()
                        let top = $(item).offset().top
                        console.log(parentOffsetTop,containerScrollTop, top, window.innerHeight, height)
                        if ((containerScrollTop + window.innerHeight >= parentOffsetTop) && (containerScrollTop + window.innerHeight <= parentOffsetTop + height)) {
                            console.log('进入可视区域:',index)
                        } else {
                            console.log('离开可视区域:',index)
                        }
                        if ((containerScrollTop + window.innerHeight >= parentOffsetTop + 50*3) && (containerScrollTop + window.innerHeight <= parentOffsetTop + height)) {
                            this.isSticky = true
                        } else {
                            this.isSticky = false
                        }
                    })
                }
            }
        }
    })
</script>
</body>
</html>